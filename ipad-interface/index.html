<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Instagram Saver</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #6B46C1 0%, #9333EA 100%);
      color: white;
      min-height: 100vh;
      overflow: hidden;
      touch-action: manipulation;
    }

    .container {
      padding: 20px;
      max-width: 100vw;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Status Bar */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #EF4444;
      transition: background 0.3s ease;
    }

    .status-dot.connected {
      background: #10B981;
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
    }

    .status-text {
      font-size: 16px;
      font-weight: 600;
    }

    .settings-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 24px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .settings-btn:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.3);
    }

    /* Current Content Display */
    .content-display {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      min-height: 100px;
    }

    .content-platform {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    .content-url {
      font-size: 16px;
      word-break: break-all;
      line-height: 1.5;
    }

    .content-empty {
      text-align: center;
      opacity: 0.6;
      font-size: 16px;
    }

    /* Tag Grid */
    .tag-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 20px;
      flex: 1;
      align-content: start;
    }

    .tag-button {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      padding: 20px;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 18px;
      font-weight: 600;
      color: white;
      user-select: none;
    }

    .tag-button:active {
      transform: scale(0.95);
    }

    .tag-button.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .tag-icon {
      font-size: 40px;
    }

    .tag-name {
      text-align: center;
    }

    /* Animations */
    @keyframes success-flash {
      0%, 100% { background: rgba(255, 255, 255, 0.2); }
      50% { background: rgba(16, 185, 129, 0.8); transform: scale(1.05); }
    }

    @keyframes error-shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .tag-button.success {
      animation: success-flash 0.3s ease;
    }

    .tag-button.error {
      animation: error-shake 0.3s ease;
      background: rgba(239, 68, 68, 0.5);
    }

    /* Toast Notification */
    #toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      transition: transform 0.3s ease;
      z-index: 1000;
    }

    #toast.show {
      transform: translateX(-50%) translateY(0);
    }

    /* Settings Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 999;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, #7C3AED 0%, #A855F7 100%);
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
    }

    .close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 28px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      line-height: 1;
    }

    .setting-group {
      margin-bottom: 25px;
    }

    .setting-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      opacity: 0.9;
    }

    .setting-input {
      width: 100%;
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      color: white;
      font-size: 16px;
      font-family: inherit;
    }

    .setting-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .tag-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .tag-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .tag-item input {
      flex: 1;
      min-width: 0;
    }

    .tag-color-picker {
      width: 50px;
      height: 40px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      cursor: pointer;
    }

    .tag-remove-btn {
      background: rgba(239, 68, 68, 0.3);
      border: 2px solid rgba(239, 68, 68, 0.5);
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
    }

    .add-tag-btn {
      background: rgba(16, 185, 129, 0.3);
      border: 2px solid rgba(16, 185, 129, 0.5);
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      margin-top: 10px;
    }

    button:active {
      transform: scale(0.98);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-indicator">
        <div class="status-dot" id="statusDot"></div>
        <div class="status-text" id="statusText">Connecting...</div>
      </div>
      <button class="settings-btn" id="settingsBtn">‚öôÔ∏è</button>
    </div>

    <!-- Current Content Display -->
    <div class="content-display">
      <div id="contentDisplay" class="content-empty">
        Waiting for content...
      </div>
    </div>

    <!-- Tag Buttons Grid -->
    <div class="tag-grid" id="tagGrid">
      <!-- Tags will be dynamically inserted here -->
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast"></div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Settings</div>
        <button class="close-btn" id="closeModal">√ó</button>
      </div>

      <div class="setting-group">
        <label class="setting-label">Server URL</label>
        <input type="text" class="setting-input" id="serverUrlInput" placeholder="ws://192.168.1.5:8080">
      </div>

      <div class="setting-group">
        <label class="setting-label">Tags</label>
        <div class="tag-list" id="tagList">
          <!-- Tag items will be dynamically inserted here -->
        </div>
        <button class="add-tag-btn" id="addTagBtn">+ Add Tag</button>
      </div>
    </div>
  </div>

  <script>
    // ===== STATE MANAGEMENT =====
    let ws = null;
    let isConnected = false;
    let currentContent = null;
    let reconnectTimer = null;
    
    const DEFAULT_TAGS = [
      { id: 1, name: 'Technology', color: '#4CAF50', icon: 'üíª' },
      { id: 2, name: 'Motivation', color: '#2196F3', icon: 'üí™' },
      { id: 3, name: 'Information', color: '#FF9800', icon: 'üìö' },
      { id: 4, name: 'Companies', color: '#E91E63', icon: 'üè¢' },
      { id: 5, name: 'Design', color: '#9C27B0', icon: 'üé®' },
      { id: 6, name: 'Coding', color: '#00BCD4', icon: '‚å®Ô∏è' }
    ];

    // ===== CONFIGURATION =====
    function loadConfig() {
      const serverUrl = localStorage.getItem('serverUrl') || `ws://${window.location.hostname}:${window.location.port}`;
      const tagsJSON = localStorage.getItem('tags');
      const tags = tagsJSON ? JSON.parse(tagsJSON) : DEFAULT_TAGS;
      
      return { serverUrl, tags };
    }

    function saveConfig(config) {
      localStorage.setItem('serverUrl', config.serverUrl);
      localStorage.setItem('tags', JSON.stringify(config.tags));
    }

    let config = loadConfig();

    // ===== UI ELEMENTS =====
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const contentDisplay = document.getElementById('contentDisplay');
    const tagGrid = document.getElementById('tagGrid');
    const toast = document.getElementById('toast');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeModal = document.getElementById('closeModal');
    const serverUrlInput = document.getElementById('serverUrlInput');
    const tagList = document.getElementById('tagList');
    const addTagBtn = document.getElementById('addTagBtn');

    // ===== WEBSOCKET CONNECTION =====
    function connectWebSocket() {
      console.log('[IPAD] Connecting to server:', config.serverUrl);
      
      try {
        ws = new WebSocket(config.serverUrl);

        ws.onopen = () => {
          console.log('[IPAD] Connected to server');
          isConnected = true;
          updateConnectionStatus(true);
          
          // Register as iPad client
          ws.send(JSON.stringify({
            type: 'register',
            client: 'ipad'
          }));
          
          clearTimeout(reconnectTimer);
        };

        ws.onmessage = (event) => {
          try {
            const message = JSON.parse(event.data);
            console.log('[IPAD] Received message:', message.type);
            handleMessage(message);
          } catch (error) {
            console.error('[IPAD] Error parsing message:', error);
          }
        };

        ws.onclose = () => {
          console.log('[IPAD] Disconnected from server');
          isConnected = false;
          updateConnectionStatus(false);
          
          // Auto-reconnect after 5 seconds
          reconnectTimer = setTimeout(() => {
            console.log('[IPAD] Attempting to reconnect...');
            connectWebSocket();
          }, 5000);
        };

        ws.onerror = (error) => {
          console.error('[IPAD] WebSocket error:', error);
        };
      } catch (error) {
        console.error('[IPAD] Failed to create WebSocket:', error);
        updateConnectionStatus(false);
        
        // Retry after 5 seconds
        reconnectTimer = setTimeout(connectWebSocket, 5000);
      }
    }

    // ===== MESSAGE HANDLING =====
    function handleMessage(message) {
      switch (message.type) {
        case 'registered':
          console.log('[IPAD] Registration confirmed');
          showToast('Connected to server');
          break;

        case 'current_content':
          console.log('[IPAD] Current content updated:', message.url);
          currentContent = message;
          updateContentDisplay(message);
          break;

        case 'save_confirmation':
          console.log('[IPAD] Save confirmation:', message.success);
          handleSaveConfirmation(message);
          break;

        default:
          console.log('[IPAD] Unknown message type:', message.type);
      }
    }

    function sendMessage(message) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(message));
        return true;
      } else {
        console.error('[IPAD] WebSocket not connected');
        showToast('Not connected to server', true);
        return false;
      }
    }

    // ===== UI UPDATES =====
    function updateConnectionStatus(connected) {
      if (connected) {
        statusDot.classList.add('connected');
        statusText.textContent = 'Connected';
      } else {
        statusDot.classList.remove('connected');
        statusText.textContent = 'Disconnected';
      }
    }

    function updateContentDisplay(content) {
      if (content && content.url) {
        contentDisplay.innerHTML = `
          <div class="content-platform">${content.platform || 'Unknown'}</div>
          <div class="content-url">${content.url}</div>
        `;
        contentDisplay.classList.remove('content-empty');
      } else {
        contentDisplay.innerHTML = 'Waiting for content...';
        contentDisplay.classList.add('content-empty');
      }
    }

    function renderTags() {
      tagGrid.innerHTML = '';
      
      config.tags.forEach(tag => {
        const button = document.createElement('button');
        button.className = 'tag-button';
        button.innerHTML = `
          <div class="tag-icon">${tag.icon}</div>
          <div class="tag-name">${tag.name}</div>
        `;
        button.style.background = `${tag.color}40`;
        button.style.borderColor = `${tag.color}80`;
        
        if (!isConnected || !currentContent) {
          button.classList.add('disabled');
        }
        
        button.addEventListener('click', () => handleTagClick(tag));
        tagGrid.appendChild(button);
      });
    }

    function handleTagClick(tag) {
      if (!isConnected || !currentContent) {
        showToast('Not ready to save', true);
        return;
      }

      const button = event.currentTarget;
      button.classList.add('disabled');

      console.log('[IPAD] Save initiated:', tag.name);
      
      const success = sendMessage({
        type: 'save_to_tag',
        tag: tag.name,
        url: currentContent.url
      });

      if (!success) {
        button.classList.remove('disabled');
      }
    }

    function handleSaveConfirmation(message) {
      const buttons = tagGrid.querySelectorAll('.tag-button');
      buttons.forEach(btn => {
        if (btn.querySelector('.tag-name').textContent === message.tag) {
          btn.classList.remove('disabled');
          
          if (message.success) {
            btn.classList.add('success');
            showToast(`Saved to ${message.tag}`, false);
            setTimeout(() => btn.classList.remove('success'), 300);
          } else {
            btn.classList.add('error');
            showToast(`Failed to save to ${message.tag}`, true);
            setTimeout(() => btn.classList.remove('error'), 300);
          }
        }
      });
    }

    function showToast(message, isError = false) {
      toast.textContent = (isError ? '‚ùå ' : '‚úÖ ') + message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ===== SETTINGS MODAL =====
    function openSettings() {
      serverUrlInput.value = config.serverUrl;
      renderTagSettings();
      settingsModal.classList.add('show');
    }

    function closeSettings() {
      settingsModal.classList.remove('show');
      
      // Save server URL
      const newServerUrl = serverUrlInput.value.trim();
      if (newServerUrl !== config.serverUrl) {
        config.serverUrl = newServerUrl;
        saveConfig(config);
        
        // Reconnect with new URL
        if (ws) {
          ws.close();
        }
        setTimeout(connectWebSocket, 500);
      }
      
      renderTags();
    }

    function renderTagSettings() {
      tagList.innerHTML = '';
      
      config.tags.forEach((tag, index) => {
        const item = document.createElement('div');
        item.className = 'tag-item';
        item.innerHTML = `
          <input type="text" class="setting-input" value="${tag.icon}" 
                 placeholder="Icon" maxlength="2" data-index="${index}" data-field="icon">
          <input type="text" class="setting-input" value="${tag.name}" 
                 placeholder="Name" data-index="${index}" data-field="name">
          <input type="color" class="tag-color-picker" value="${tag.color}" 
                 data-index="${index}" data-field="color">
          <button class="tag-remove-btn" data-index="${index}">Remove</button>
        `;
        tagList.appendChild(item);
      });

      // Add event listeners
      tagList.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', handleTagEdit);
      });

      tagList.querySelectorAll('.tag-remove-btn').forEach(btn => {
        btn.addEventListener('click', handleTagRemove);
      });
    }

    function handleTagEdit(event) {
      const index = parseInt(event.target.dataset.index);
      const field = event.target.dataset.field;
      const value = event.target.value;

      if (config.tags[index]) {
        config.tags[index][field] = value;
        saveConfig(config);
      }
    }

    function handleTagRemove(event) {
      const index = parseInt(event.target.dataset.index);
      config.tags.splice(index, 1);
      saveConfig(config);
      renderTagSettings();
    }

    function addTag() {
      const newTag = {
        id: Date.now(),
        name: 'New Tag',
        color: '#' + Math.floor(Math.random()*16777215).toString(16),
        icon: '‚≠ê'
      };
      config.tags.push(newTag);
      saveConfig(config);
      renderTagSettings();
    }

    // ===== EVENT LISTENERS =====
    settingsBtn.addEventListener('click', openSettings);
    closeModal.addEventListener('click', closeSettings);
    addTagBtn.addEventListener('click', addTag);

    settingsModal.addEventListener('click', (e) => {
      if (e.target === settingsModal) {
        closeSettings();
      }
    });

    // ===== INITIALIZATION =====
    console.log('[IPAD] Initializing iPad interface');
    renderTags();
    connectWebSocket();
  </script>
</body>
</html>
